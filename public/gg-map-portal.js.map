{"version":3,"sources":["leaflet.wms.js","gg-map-portal.js"],"names":["wms","Source","Layer","extend","url","options","Util","setOptions","tiled","untiled","_url","_subLayers","_overlay","createOverlay","overlayOptions","opt","overlay","tileLayer","refreshOverlay","_map","removeFrom","identify","opacity","setOpacity","isBack","bringToBack","bringToFront","name","layer","newSubLayers","i","length","subLayers","Object","keys","join","setParams","addTo","remove","evt","layers","getIdentifyLayers","getFeatureInfo","containerPoint","latlng","showFeatureInfo","point","callback","params","getFeatureInfoParams","getParamString","showWaiting","ajax","done","result","hideWaiting","text","parseFeatureInfo","call","identifyLayers","wmsParams","updateWmsParams","infoParams","Math","round","x","y","info","openPopup","_container","style","cursor","source","layerName","addSubLayer","getSourceForUrl","_source","_name","removeSubLayer","sources","TileLayer","TileLayerWMS","tileLayerWMS","Overlay","opts","defaultWmsParams","update","attribution","map","_currentOverlay","removeLayer","_currentUrl","getImageUrl","bounds","getBounds","ImageOverlay","LatLngBounds","getNorthEast","getSouthWest","once","_swap","getZoom","minZoom","maxZoom","size","getSize","wmsVersion","parseFloat","version","crs","projectionKey","nw","project","getNorthWest","se","getSouthEast","code","bbox","EPSG4326","uppercase","pstr","context","request","XMLHttpRequest","onreadystatechange","change","readyState","status","responseText","open","send","mapTemplate","document","createElement","innerHTML","downloadTemplate","GGMapPortal","HTMLElement","constructor","attachShadow","mode","shadowRoot","appendChild","content","cloneNode","hasAttribute","config","getAttribute","console","error","state","baseMap","baseMaps","baseMapNames","wmsGroups","geojsonLayers","overlayCollapses","_markersGroup","L","featureGroup","window","onpopstate","previousBaseMap","_initializeState","location","hash","overlayMaps","warn","_pushState","selectedOverlay","machineName","toggleCollapse","overlaySelect","bind","connectedCallback","fetch","then","r","initializeMap","response","rjson","e","mapProperties","downloadProperties","initializeSearch","searchUrl","flat","mapTitle","title","getElementById","textContent","center","zoom","fitBounds","zoomControl","setPosition","attributionPrefix","attributionControl","setPrefix","querySelectorAll","forEach","t","onclick","_toggleLayersMenu","decodeURI","_initializeBaseMaps","_initializeOverlays","wmsDefaultSource","oninput","target","value","clearLayers","initialCenter","initialZoom","flyTo","innerWidth","flyToBounds","paddingTopLeft","paddingBottomRight","mapOptions","jQuery","autocomplete","preventBadQueries","deferRequestBy","minChars","serviceUrl","paramName","transformResult","suggestions","JSON","parse","addresses","d","address","data","onSearchStart","searchMakers","onSearchComplete","q","s","searchMarkers","obj","coords","latitude","longitude","_markMap","onSelect","initialState","substring","split","findIndex","m","isNaN","parseInt","alert","baseMapConfig","format","on","default","find","key","control","newBaseMap","accordionDiv","classList","add","overlayConfig","overlayTemplate","overlayItem","firstElementChild","querySelector","description","_toggleOverlay","overlayCollapse","bootstrap","Collapse","toggle","startCollapse","id","slice","disabled","postCollapse","addEventListener","layerList","flattenedLayers","type","j","interaction","visible","layerTemplate","layerItem","_toggleLayer","stopPropagation","preventDefault","_downloadLayer","undefined","concat","filter","l","push","button","contains","collapsed","index","layerIndex","shortName","currVisible","indexOf","splice","_parseLayers","item","getElementsByTagName","resetViewOnSelect","wmsLayers","_syncStateLayers","ok","json","_createGeoJSONLayer","slider","checked","WMS","transparent","replaceAllSubLayers","stateOverlay","stateLayers","history","pushState","visibleLayers","includes","notLayers","clusterGroup","cluster","markerClusterGroup","showCoverageOnHover","maxClusterRadius","geoJSONOptions","pointToLayer","feature","marker","circleMarker","markerStyle","bindPopup","_generatePopupContent","addLayer","geoJSONLayer","geoJSON","rows","p","properties","replace","txt","charAt","toUpperCase","substr","toLowerCase","markersData","icon","iconUrl","shadowUrl","iconShadow","iconSize","iconAnchor","popupAnchor","tooltipAnchor","shadowSize","dom","modal","Modal","hide","downloadURL","downloadLinks","link","formatUrl","show","customElements","define"],"mappings":"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","file":"gg-map-portal.js","sourceRoot":"..\\src","sourcesContent":["/*!\r\n * leaflet.wms.js\r\n * A collection of Leaflet utilities for working with Web Mapping services.\r\n * (c) 2014-2016, Houston Engineering, Inc.\r\n * MIT License\r\n */\r\n\r\nimport { Layer } from 'leaflet/src/layer/Layer';\r\nimport { ImageOverlay } from 'leaflet/src/layer/ImageOverlay';\r\nimport { TileLayerWMS, tileLayerWMS } from 'leaflet/src/layer/tile/TileLayer.WMS';\r\nimport { EPSG4326 } from 'leaflet/src/geo/crs/CRS.EPSG4326';\r\nimport { LatLngBounds } from 'leaflet/src/geo/LatLngBounds';\r\nimport * as Util from 'leaflet/src/core/Util';\r\n\r\nexport var wms = {};\r\n\r\n/*\r\n * wms.Source\r\n * The Source object manages a single WMS connection.  Multiple \"layers\" can be\r\n * created with the getLayer function, but a single request will be sent for\r\n * each image update.  Can be used in non-tiled \"overlay\" mode (default), or\r\n * tiled mode, via an internal wms.Overlay or wms.TileLayer, respectively.\r\n */\r\nwms.Source = Layer.extend({\r\n    'options': {\r\n        'untiled': true,\r\n        'identify': true\r\n    },\r\n\r\n    'initialize': function(url, options) {\r\n        Util.setOptions(this, options);\r\n        if (this.options.tiled) {\r\n            this.options.untiled = false;\r\n        }\r\n        this._url = url;\r\n        this._subLayers = {};\r\n        this._overlay = this.createOverlay(this.options.untiled);\r\n    },\r\n\r\n    'createOverlay': function(untiled) {\r\n        // Create overlay with all options other than untiled & identify\r\n        var overlayOptions = {};\r\n        for (var opt in this.options) {\r\n            if (opt != 'untiled' && opt != 'identify') {\r\n                overlayOptions[opt] = this.options[opt];\r\n            }\r\n        }\r\n        if (untiled) {\r\n            return wms.overlay(this._url, overlayOptions);\r\n        } else {\r\n            return wms.tileLayer(this._url, overlayOptions);\r\n        }\r\n    },\r\n\r\n    'onAdd': function() {\r\n        this.refreshOverlay();\r\n    },\r\n\r\n    'onRemove': function () {\r\n        if (this._map) this._overlay.removeFrom(this._map);\r\n    },\r\n\r\n    'getEvents': function() {\r\n        if (this.options.identify) {\r\n            return {'click': this.identify};\r\n        } else {\r\n            return {};\r\n        }\r\n    },\r\n\r\n    'setOpacity': function(opacity) {\r\n         this.options.opacity = opacity;\r\n         if (this._overlay) {\r\n             this._overlay.setOpacity(opacity);\r\n         }\r\n    },\r\n    \r\n    'bringToBack': function() {\r\n         this.options.isBack = true;\r\n         if (this._overlay) {\r\n             this._overlay.bringToBack();\r\n         }\r\n    },\r\n\r\n    'bringToFront': function() {\r\n         this.options.isBack = false;\r\n         if (this._overlay) {\r\n             this._overlay.bringToFront();\r\n         }\r\n    },\r\n\r\n    'getLayer': function(name) {\r\n        return wms.layer(this, name);\r\n    },\r\n\r\n    'getSubLayers': function () {\r\n        return this._subLayers;\r\n    },\r\n\r\n    'addSubLayer': function(name) {\r\n        this._subLayers[name] = true;\r\n        this.refreshOverlay();\r\n    },\r\n\r\n    'removeSubLayer': function(name) {\r\n        delete this._subLayers[name];\r\n        this.refreshOverlay();\r\n    },\r\n\r\n    /* Efficient way to swap out all sub layers */\r\n    'replaceAllSubLayers': function (newSubLayers) {\r\n        this._subLayers = {};\r\n        for (var i = 0; i < newSubLayers.length; i++) this._subLayers[newSubLayers[i]] = true;\r\n        this.refreshOverlay();\r\n    },\r\n\r\n    'refreshOverlay': function() {\r\n        var subLayers = Object.keys(this._subLayers).join(\",\");\r\n        if (!this._map) {\r\n            return;\r\n        }\r\n        if (!subLayers) {\r\n            this._overlay.remove();\r\n        } else {\r\n            this._overlay.setParams({'layers': subLayers});\r\n            this._overlay.addTo(this._map);\r\n        }\r\n    },\r\n\r\n    'identify': function(evt) {\r\n        // Identify map features in response to map clicks. To customize this\r\n        // behavior, create a class extending wms.Source and override one or\r\n        // more of the following hook functions.\r\n\r\n        var layers = this.getIdentifyLayers();\r\n        if (!layers.length) {\r\n            return;\r\n        }\r\n        this.getFeatureInfo(\r\n            evt.containerPoint, evt.latlng, layers,\r\n            this.showFeatureInfo\r\n        );\r\n    },\r\n\r\n    'getFeatureInfo': function(point, latlng, layers, callback) {\r\n        // Request WMS GetFeatureInfo and call callback with results\r\n        // (split from identify() to faciliate use outside of map events)\r\n        var params = this.getFeatureInfoParams(point, layers),\r\n            url = this._url + Util.getParamString(params, this._url);\r\n\r\n        this.showWaiting();\r\n        this.ajax(url, done);\r\n\r\n        function done(result) {\r\n            this.hideWaiting();\r\n            var text = this.parseFeatureInfo(result, url);\r\n            callback.call(this, latlng, text);\r\n        }\r\n    },\r\n\r\n    'ajax': function(url, callback) {\r\n        wms.ajax.call(this, url, callback);\r\n    },\r\n\r\n    'getIdentifyLayers': function() {\r\n        // Hook to determine which layers to identify\r\n        if (this.options.identifyLayers)\r\n            return this.options.identifyLayers;\r\n        return Object.keys(this._subLayers);\r\n     },\r\n\r\n    'getFeatureInfoParams': function(point, layers) {\r\n        // Hook to generate parameters for WMS service GetFeatureInfo request\r\n        var wmsParams, overlay;\r\n        if (this.options.untiled) {\r\n            // Use existing overlay\r\n            wmsParams = this._overlay.wmsParams;\r\n        } else {\r\n            // Create overlay instance to leverage updateWmsParams\r\n            overlay = this.createOverlay(true);\r\n            overlay.updateWmsParams(this._map);\r\n            wmsParams = overlay.wmsParams;\r\n            wmsParams.layers = layers.join(',');\r\n        }\r\n        var infoParams = {\r\n            'request': 'GetFeatureInfo',\r\n            'query_layers': layers.join(','),\r\n            'X': Math.round(point.x),\r\n            'Y': Math.round(point.y)\r\n        };\r\n        return Util.extend({}, wmsParams, infoParams);\r\n    },\r\n\r\n    'parseFeatureInfo': function(result, url) {\r\n        // Hook to handle parsing AJAX response\r\n        if (result == \"error\") {\r\n            // AJAX failed, possibly due to CORS issues.\r\n            // Try loading content in <iframe>.\r\n            result = \"<iframe src='\" + url + \"' style='border:none'>\";\r\n        }\r\n        return result;\r\n    },\r\n\r\n    'showFeatureInfo': function(latlng, info) {\r\n        // Hook to handle displaying parsed AJAX response to the user\r\n        if (!this._map) {\r\n            return;\r\n        }\r\n        this._map.openPopup(info, latlng);\r\n    },\r\n\r\n    'showWaiting': function() {\r\n        // Hook to customize AJAX wait animation\r\n        if (!this._map)\r\n            return;\r\n        this._map._container.style.cursor = \"progress\";\r\n    },\r\n\r\n    'hideWaiting': function() {\r\n        // Hook to remove AJAX wait animation\r\n        if (!this._map)\r\n            return;\r\n        this._map._container.style.cursor = \"default\";\r\n    }\r\n});\r\n\r\nwms.source = function(url, options) {\r\n    return new wms.Source(url, options);\r\n};\r\n\r\n/*\r\n * Layer\r\n * Leaflet \"layer\" with all actual rendering handled via an underlying Source\r\n * object.  Can be called directly with a URL to automatically create or reuse\r\n * an existing Source.  Note that the auto-source feature doesn't work well in\r\n * multi-map environments; so for best results, create a Source first and use\r\n * getLayer() to retrieve wms.Layer instances.\r\n */\r\n\r\nwms.Layer = Layer.extend({\r\n    'initialize': function(source, layerName, options) {\r\n        Util.setOptions(this, options);\r\n        if (!source.addSubLayer) {\r\n            // Assume source is a URL\r\n            source = wms.getSourceForUrl(source, options);\r\n        }\r\n        this._source = source;\r\n        this._name = layerName;\r\n    },\r\n    'onAdd': function() {\r\n        if (!this._source._map)\r\n            this._source.addTo(this._map);\r\n        this._source.addSubLayer(this._name);\r\n    },\r\n    'onRemove': function() {\r\n        this._source.removeSubLayer(this._name);\r\n    },\r\n    'setOpacity': function(opacity) {\r\n        this._source.setOpacity(opacity);\r\n    },\r\n    'bringToBack': function() {\r\n        this._source.bringToBack();\r\n    },\r\n    'bringToFront': function() {\r\n        this._source.bringToFront();\r\n    }\r\n});\r\n\r\nwms.layer = function(source, options) {\r\n    return new wms.Layer(source, options);\r\n};\r\n\r\n// Cache of sources for use with wms.Layer auto-source option\r\nwms.sources = {};\r\nwms.getSourceForUrl = function(url, options) {\r\n    if (!wms.sources[url]) {\r\n        wms.sources[url] = wms.source(url, options);\r\n    }\r\n    return wms.sources[url];\r\n};\r\n\r\n\r\n// Copy tiled WMS layer from leaflet core, in case we need to subclass it later\r\nwms.TileLayer = TileLayerWMS;\r\nwms.tileLayer = tileLayerWMS;\r\n\r\n/*\r\n * wms.Overlay:\r\n * \"Single Tile\" WMS image overlay that updates with map changes.\r\n * Portions of wms.Overlay are directly extracted from L.TileLayer.WMS.\r\n * See Leaflet license.\r\n */\r\nwms.Overlay = Layer.extend({\r\n    'defaultWmsParams': {\r\n        'service': 'WMS',\r\n        'request': 'GetMap',\r\n        'version': '1.1.1',\r\n        'layers': '',\r\n        'styles': '',\r\n        'format': 'image/jpeg',\r\n        'transparent': false\r\n    },\r\n\r\n    'options': {\r\n        'crs': null,\r\n        'uppercase': false,\r\n        'attribution': '',\r\n        'opacity': 1,\r\n        'isBack': false,\r\n        'minZoom': 0,\r\n        'maxZoom': 18\r\n    },\r\n\r\n    'initialize': function(url, options) {\r\n        this._url = url;\r\n\r\n        // Move WMS parameters to params object\r\n        var params = {}, opts = {};\r\n        for (var opt in options) {\r\n             if (opt in this.options) {\r\n                 opts[opt] = options[opt];\r\n             } else {\r\n                 params[opt] = options[opt];\r\n             }\r\n        }\r\n        Util.setOptions(this, opts);\r\n        this.wmsParams = Util.extend({}, this.defaultWmsParams, params);\r\n    },\r\n\r\n    'setParams': function(params) {\r\n        Util.extend(this.wmsParams, params);\r\n        this.update();\r\n    },\r\n\r\n    'getAttribution': function() {\r\n        return this.options.attribution;\r\n    },\r\n\r\n    'onAdd': function() {\r\n        this.update();\r\n    },\r\n\r\n    'onRemove': function(map) {\r\n        if (this._currentOverlay) {\r\n            map.removeLayer(this._currentOverlay);\r\n            delete this._currentOverlay;\r\n        }\r\n        if (this._currentUrl) {\r\n            delete this._currentUrl;\r\n        }\r\n    },\r\n\r\n    'getEvents': function() {\r\n        return {\r\n            'moveend': this.update\r\n        };\r\n    },\r\n\r\n    'update': function() {\r\n        if (!this._map) {\r\n            return;\r\n        }\r\n        // Determine image URL and whether it has changed since last update\r\n        this.updateWmsParams();\r\n        var url = this.getImageUrl();\r\n        if (this._currentUrl == url) {\r\n            return;\r\n        }\r\n        this._currentUrl = url;\r\n\r\n        // Keep current image overlay in place until new one loads\r\n        // (inspired by esri.leaflet)\r\n        var bounds = this._map.getBounds();\r\n        var overlay = new ImageOverlay(url, new LatLngBounds(bounds.getNorthEast(), bounds.getSouthWest()), {'opacity': 0});\r\n        overlay.addTo(this._map);\r\n        overlay.once('load', _swap, this);\r\n        function _swap() {\r\n            if (!this._map) {\r\n                return;\r\n            }\r\n            if (overlay._url != this._currentUrl) {\r\n                this._map.removeLayer(overlay);\r\n                return;\r\n            } else if (this._currentOverlay) {\r\n                this._map.removeLayer(this._currentOverlay);\r\n            }\r\n            this._currentOverlay = overlay;\r\n            overlay.setOpacity(\r\n                this.options.opacity ? this.options.opacity : 1\r\n            );\r\n            if (this.options.isBack === true) {\r\n                overlay.bringToBack();\r\n            }\r\n            if (this.options.isBack === false) {\r\n                overlay.bringToFront();\r\n            }\r\n        }\r\n        if ((this._map.getZoom() < this.options.minZoom) ||\r\n            (this._map.getZoom() > this.options.maxZoom)){\r\n            this._map.removeLayer(overlay);\r\n        }\r\n    },\r\n\r\n    'setOpacity': function(opacity) {\r\n         this.options.opacity = opacity;\r\n         if (this._currentOverlay) {\r\n             this._currentOverlay.setOpacity(opacity);\r\n         }\r\n    },\r\n\r\n    'bringToBack': function() {\r\n        this.options.isBack = true;\r\n        if (this._currentOverlay) {\r\n            this._currentOverlay.bringToBack();\r\n        }\r\n    },\r\n\r\n    'bringToFront': function() {\r\n        this.options.isBack = false;\r\n        if (this._currentOverlay) {\r\n            this._currentOverlay.bringToFront();\r\n        }\r\n    },\r\n\r\n    // See L.TileLayer.WMS: onAdd() & getTileUrl()\r\n    'updateWmsParams': function(map) {\r\n        if (!map) {\r\n            map = this._map;\r\n        }\r\n        // Compute WMS options\r\n        var bounds = map.getBounds();\r\n        var size = map.getSize();\r\n        var wmsVersion = parseFloat(this.wmsParams.version);\r\n        var crs = this.options.crs || map.options.crs;\r\n        var projectionKey = wmsVersion >= 1.3 ? 'crs' : 'srs';\r\n        var nw = crs.project(bounds.getNorthWest());\r\n        var se = crs.project(bounds.getSouthEast());\r\n\r\n        // Assemble WMS parameter string\r\n        var params = {\r\n            'width': size.x,\r\n            'height': size.y\r\n        };\r\n        params[projectionKey] = crs.code;\r\n        params.bbox = (\r\n            wmsVersion >= 1.3 && crs.code === EPSG4326.code ?\r\n            [se.y, nw.x, nw.y, se.x] :\r\n            [nw.x, se.y, se.x, nw.y]\r\n        ).join(',');\r\n\r\n        Util.extend(this.wmsParams, params);\r\n    },\r\n\r\n    'getImageUrl': function() {\r\n        var uppercase = this.options.uppercase || false;\r\n        var pstr = Util.getParamString(this.wmsParams, this._url, uppercase);\r\n        return this._url + pstr;\r\n    }\r\n});\r\n\r\nwms.overlay = function(url, options) {\r\n    return new wms.Overlay(url, options);\r\n};\r\n\r\n// Simple AJAX helper (since we can't assume jQuery etc. are present)\r\nwms.ajax = function (url, callback) {\r\n    var context = this,\r\n        request = new XMLHttpRequest();\r\n    request.onreadystatechange = change;\r\n    request.open('GET', url);\r\n    request.send();\r\n\r\n    function change() {\r\n        if (request.readyState === 4) {\r\n            if (request.status === 200) {\r\n                callback.call(context, request.responseText);\r\n            } else {\r\n                callback.call(context, \"error\");\r\n            }\r\n        }\r\n    }\r\n};","import 'leaflet';\r\nimport 'leaflet.markercluster';\r\nimport icon from 'leaflet/dist/images/marker-icon.png';\r\nimport iconShadow from 'leaflet/dist/images/marker-shadow.png';\r\nimport * as bootstrap from 'bootstrap';\r\nimport { load } from 'js-yaml';\r\nimport { wms as WMS } from './leaflet.wms.js';\r\n\r\n// const icon = new URL('leaflet/dist/images/marker-icon.png', import.meta.url);\r\n// const iconShadow = new URL('leaflet/dist/images/marker-shadow.png', import.meta.url);\r\n\r\n// Map Portal Template\r\nlet mapTemplate = document.createElement('template');\r\nmapTemplate.innerHTML = /*html*/`\r\n  <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css\"\r\n    integrity=\"sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU\"\r\n    crossorigin=\"anonymous\">\r\n  <link href=\"https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css\" rel=\"stylesheet\"\r\n    integrity=\"sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN\"\r\n    crossorigin=\"anonymous\">\r\n  <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.7.1/dist/leaflet.css\"\r\n    integrity=\"sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==\"\r\n    crossorigin=\"\">\r\n  <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css\" media=\"screen\">\r\n  <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css\" media=\"screen\">\r\n  <style>\r\n    #map {\r\n      width: 100vw;\r\n        height: 100vh;\r\n        padding: 0;\r\n        margin: 0;\r\n    }\r\n\r\n    :host {\r\n      font-family: system-ui,-apple-system,\"Segoe UI\",Roboto,\"Helvetica Neue\",Arial,\"Noto Sans\",\"Liberation Sans\",sans-serif;\r\n      --primary-color: #003d7d;\r\n      --secondary-color: #ff4b5f;\r\n    }\r\n\r\n    main.card {\r\n      position: absolute;\r\n      left: 15px;\r\n      top: 15px;\r\n      bottom: 15px;\r\n      width: 300px;\r\n      z-index: 1005;\r\n\r\n      background-color: #fff;\r\n      box-shadow: 0 8px 10px 1px rgba(0, 0, 0, 0.14), 0 3px 14px 2px rgba(0, 0, 0, 0.12), 0 5px 5px -3px rgba(0, 0, 0, 0.3);\r\n\r\n      transition: transform 175ms;\r\n    }\r\n\r\n    a {\r\n      color: var(--primary-color, inherit);\r\n    }\r\n\r\n    .btn-primary {\r\n      color: #fff;\r\n      background-color: var(--primary-color, inherit);\r\n      border-color: var(--primary-color, inherit);\r\n    }\r\n\r\n    header#page-title {\r\n      padding: 10px;\r\n      background-color: var(--primary-color);\r\n    }\r\n\r\n    header#page-title h1 {\r\n      color: #fff;\r\n      font-weight: 700;\r\n      font-size: xx-large;\r\n    }\r\n\r\n    section#overlays {\r\n      overflow: auto;\r\n      padding-bottom: 5px;\r\n      overflow-y:scroll;\r\n    }\r\n\r\n    section#overlays .overlay-item {\r\n      font-size: 1.1rem;\r\n      color: #444;\r\n    }\r\n\r\n    section#overlays .overlay-item:hover {\r\n      cursor: pointer;\r\n      background-color: #eee;\r\n    }\r\n\r\n    section#overlays .overlay-item.selected {\r\n      background-color: #ddd;\r\n      color: var(--primary-color);\r\n\r\n      /* left border and offset text back */\r\n      border-left: 0.25rem solid var(--primary-color);\r\n      padding-left: 1rem;\r\n    }\r\n\r\n    ul.overlay-layers>li.list-group-item {\r\n      border: 0;\r\n      border-left: 0.25rem solid var(--primary-color);\r\n      padding-left: 1.75rem;\r\n      background-color: #eee;\r\n      cursor: pointer;\r\n    }\r\n\r\n    ul.overlay-layers .overlay-layers-toggle {\r\n      --primary-color: var(--secondary-color);\r\n    }\r\n\r\n    button#layers-menu-toggle {\r\n      position: absolute;\r\n      display: none;\r\n      right: 10px;\r\n      bottom: 90px;\r\n      width: 160px;\r\n      height: 90px;\r\n      z-index: 1001;\r\n      border: 2px solid #ffffff;\r\n      box-shadow: 0 2px 2px 1px rgba(0, 0, 0, 0.14), 0 1px 3px 1px rgba(0, 0, 0, 0.12), 0 2px 2px -1px rgba(0, 0, 0, 0.3);\r\n      cursor: pointer;\r\n    }\r\n\r\n    section#download-disclaimer {\r\n      max-height: 400px;\r\n      overflow: auto;\r\n      text-align: justify;\r\n    }\r\n\r\n    .show-mobile {\r\n      display: none;\r\n    }\r\n\r\n    @media (max-width: 600px) {\r\n      main.card {\r\n        right: 30px;\r\n        left: 30px;\r\n        top: 30px;\r\n        bottom: 30px;\r\n        width: unset;\r\n        transform: scale(0);\r\n      }\r\n\r\n      main.show {\r\n        transform: scale(1);\r\n      }\r\n\r\n      .show-mobile {\r\n        display: block;\r\n      }\r\n\r\n      button#layers-menu-toggle {\r\n        display: block;\r\n        width: 48px;\r\n        height: 48px;\r\n        border-radius: 5px;\r\n      }\r\n    }\r\n\r\n    .switch {\r\n      position: relative;\r\n      display: inline-block;\r\n      width: 40px;\r\n      height: 30px;\r\n      margin-right: 12px;\r\n      padding-right: 40px;\r\n    }\r\n\r\n    /* Hide default HTML checkbox */\r\n    .switch input {\r\n      opacity: 0;\r\n      width: 0;\r\n      height: 0;\r\n    }\r\n\r\n    /* The slider */\r\n    .slider {\r\n      position: absolute;\r\n      cursor: pointer;\r\n      top: 0;\r\n      left: -16px;\r\n      right: 0;\r\n      bottom: 0;\r\n      background-color: #ccc;\r\n      border-radius: 30px;\r\n      -webkit-transition: .4s;\r\n      transition: .4s;\r\n    }\r\n\r\n    .slider:before {\r\n      position: absolute;\r\n      content: \"\";\r\n      height: 22px;\r\n      width: 22px;\r\n      left: 4px;\r\n      bottom: 4px;\r\n      background-color: white;\r\n      border-radius: 50%;\r\n      -webkit-transition: .4s;\r\n      transition: .4s;\r\n    }\r\n\r\n    input:checked + .slider {\r\n      background-color: var(--primary-color);\r\n    }\r\n\r\n    input:focus + .slider {\r\n      box-shadow: 0 0 1px #2196F3;\r\n    }\r\n\r\n    input:checked + .slider:before {\r\n      -webkit-transform: translateX(26px);\r\n      -ms-transform: translateX(26px);\r\n      transform: translateX(26px);\r\n    }\r\n\r\n    .accordion-button:focus {\r\n      box-shadow: none;\r\n    }\r\n\r\n    .accordion-button:not(.collapsed)::after {\r\n      background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23003d7d'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e\");\r\n    }\r\n\r\n    .collapsing {\r\n      -webkit-transition: none;\r\n      transition: none;\r\n      display: none;\r\n    }\r\n  </style>\r\n\r\n  <main id=\"layers-menu\" class=\"card\">\r\n    <header id=\"page-title\" class=\"card-img-top d-flex align-items-end\">\r\n      <h1 id=\"map-title\" class=\"h2\"></h1>\r\n    </header>\r\n\r\n    <!-- Search section -->\r\n    <section id=\"search-section\" class=\"input-group\">\r\n      <input type=\"text\" name=\"search\" id=\"search\" class=\"form-control rounded-0\" placeholder=\"Search address\">\r\n      <span class=\"input-group-btn rounded-0\">\r\n        <button class=\"btn btn-secondary rounded-0\">\r\n          <i class=\"fa fa-fw fa-search\"></i>\r\n        </button>\r\n      </span>\r\n    </section>\r\n\r\n    <!-- List of available overlays -->\r\n    <section id=\"overlays\"></section>\r\n\r\n    <footer class=\"card-body\">\r\n      <!-- <a href=\"#\" class=\"btn btn-link\">Help</a>\r\n      <a href=\"#\" class=\"btn btn-link\">Tour</a> -->\r\n      <div class=\"pull-right show-mobile\">\r\n        <a href=\"#\" class=\"btn btn-primary menu-toggle\">\r\n          <i class=\"fa fa-map\"></i>\r\n          View Map\r\n        </a>\r\n      </div>\r\n    </footer>\r\n  </main>\r\n\r\n  <button id=\"layers-menu-toggle\" class=\"btn btn-primary menu-toggle\"><i class=\"fa fa-bars\"></i></button>\r\n\r\n  <div id=\"map\"></div>\r\n\r\n  <script src=\"https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.10.2/umd/popper.min.js\"\r\n    integrity=\"sha512-nnzkI2u2Dy6HMnzMIkh7CPd1KX445z38XIu4jG1jGw7x5tSL3VBjE44dY4ihMU1ijAQV930SPM12cCFrB18sVw==\"\r\n    crossorigin=\"anonymous\"\r\n    referrerpolicy=\"no-referrer\"></script>\r\n  <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js\"\r\n    integrity=\"sha384-skAcpIdS7UcVUC05LJ9Dxay8AXcDYfBJqt1CJ85S/CFujBsIzCIv+l9liuYLaMQ/\"\r\n    crossorigin=\"anonymous\"></script>\r\n`;\r\n\r\n// Download Modal Template\r\nlet downloadTemplate = document.createElement('template');\r\ndownloadTemplate.innerHTML = /*html*/`\r\n  <div class=\"modal fade\" id=\"download-modal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"download-modal-label\" aria-hidden=\"true\">\r\n    <div class=\"modal-dialog modal-lg\" role=\"document\">\r\n      <div class=\"modal-content\">\r\n        <div class=\"modal-header\">\r\n          <h3 class=\"modal-title\" id=\"download-modal-label\">\r\n            <span id=\"layer-name\"></span>\r\n          </h3>\r\n          <button type=\"button\" id=\"modal-close\" class=\"btn-close\" data-dismiss=\"modal\" aria-label=\"Close\"></button>\r\n        </div>\r\n        <div class=\"modal-body\">\r\n          <section style=\"height: 400px; overflow: auto; padding: 10px; background-color: #eee; font-size: 0.85rem;\">\r\n            <h5>Download Disclaimer</h5>\r\n\r\n            <p>The City of Garden Grove provides the data as a public resource of general information for use \"as is.\" The City\r\n              of Garden Grove provides this information with the understanding that it is not guaranteed to be accurate, correct\r\n              or complete and any conclusions drawn from such information are the sole responsibility of the user. Further,\r\n              the City of Garden Grove makes no warranty, representation or guaranty as to the content, sequence, accuracy,\r\n              timeliness or completeness of any of the spatial or database information provided herein. While every effort\r\n              has been made to ensure the content, sequence, accuracy, timeliness or completeness of materials presented within\r\n              these pages, the City of Garden Grove assumes no responsibility for errors or omissions, and explicitly disclaims\r\n              any representations and warranties, including, without limitation, the implied warranties of merchantability\r\n              and fitness for a particular purpose. The City of Garden Grove shall assume no liability for:</p>\r\n            <p>1.Any errors, omissions, or inaccuracies in the information provided, regardless of how caused; or 2.Any decision\r\n              made or action taken or not taken by viewer in reliance upon any information or data furnished hereunder.</p>\r\n            <p>Availability of the City of Garden Grove GIS is not guaranteed. Applications, servers, and network connections\r\n              may be unavailable at any time for maintenance or unscheduled outages. Outages may be of long duration. Users\r\n              are cautioned to create dependencies on these services for critical needs.</p>\r\n            <p>THE FOREGOING WARRANTY IS EXCLUSIVE AND IN LIEU OF ALL OTHER WARRANTIES OF MERCHANTABILITY, FITNESS FOR PARTICULAR\r\n              PURPOSE AND/OR ANY OTHER TYPE WHETHER EXPRESSED OR IMPLIED. In no event shall The City of Garden Grove become\r\n              liable to users of these data, or any other party, for any loss or direct, indirect, special, incidental or consequential\r\n              damages, including, but not limited to, time, money or goodwill, arising from the use or modification of the\r\n              data.\r\n            </p>\r\n            <p>To assist The City of Garden Grove in the maintenance and/or correction of the data, users should provide the City\r\n              of Garden Grove with information concerning errors or discrepancies found in using the data. Please acknowledge\r\n              the City of Garden Grove as the source when data is used in the preparation of reports, papers, publications,\r\n              maps, or other products.</p>\r\n          </section>\r\n        </div>\r\n        <div class=\"modal-footer\">\r\n          <span id=\"download-buttons-label\">Download as:</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n`;\r\n\r\nclass GGMapPortal extends HTMLElement {\r\n  constructor() {\r\n    super();\r\n\r\n    this.attachShadow({mode: 'open'});\r\n    this.shadowRoot.appendChild(mapTemplate.content.cloneNode(true));\r\n\r\n    if (this.hasAttribute('config')) {\r\n      this.config = this.getAttribute('config');\r\n    } else {\r\n      console.error('Error: No map configuration specificied.');\r\n    }\r\n\r\n    this.state = {\r\n      baseMap: '',\r\n      overlay: 0,\r\n      layers: []\r\n    };\r\n    this.baseMaps = {};\r\n    this.baseMapNames = {};\r\n    this.wmsGroups = {};\r\n    this.geojsonLayers = {};\r\n    this.overlayCollapses = {};\r\n    this._markersGroup = L.featureGroup([]);\r\n\r\n    window.onpopstate = function() {\r\n      let previousBaseMap = this.baseMapNames[this.state.baseMap]\r\n      this._initializeState(location.hash);\r\n      if (previousBaseMap !== this.baseMapNames[this.state.baseMap]) {\r\n        this.baseMaps[previousBaseMap].removeFrom(this.map);\r\n        this.baseMaps[this.baseMapNames[this.state.baseMap]].addTo(this.map);\r\n      }\r\n      if (!this.overlayMaps[this.state.overlay]) {\r\n        this.state.overlay = 0\r\n        console.warn(`Warning: The overlay requested in the URL does not exist. Defaulting to ${this.overlayMaps[0].name}.`);\r\n        this._pushState();\r\n      }\r\n\r\n      if (this.selectedOverlay.machineName !== this.overlayMaps[this.state.overlay].machineName)\r\n        this.toggleCollapse(this.overlayMaps[this.state.overlay].machineName);\r\n      this.overlaySelect(this.state.overlay);\r\n    }.bind(this);\r\n  }\r\n\r\n  connectedCallback() {\r\n    // super.connectedCallback();\r\n\r\n    fetch(this.config).then(r => r.text())\r\n      .then(this.initializeMap.bind(this));\r\n  }\r\n\r\n  initializeMap(response) {\r\n    let rjson;\r\n    try {\r\n      rjson = load(response);\r\n    } catch (e) {\r\n      console.error('Error: Cannot load config file. Please ensure config.yml exists')\r\n      return;\r\n    }\r\n\r\n    this.mapProperties = rjson.mapProperties;\r\n    this.downloadProperties = rjson.downloadProperties\r\n    this.overlayMaps = rjson.overlayMaps;\r\n\r\n    this.initializeSearch(rjson.searchUrl);\r\n\r\n    if (this.overlayMaps && this.overlayMaps.length === 1) {\r\n      this.flat = true;\r\n    }\r\n\r\n    this.mapTitle = this.mapProperties.title ? this.mapProperties.title : \"Map Portal\";\r\n    this.shadowRoot.getElementById('map-title').textContent = this.mapTitle;\r\n    document.title = this.mapTitle;\r\n\r\n    if (!this.mapProperties.options) {\r\n      console.warn('Warning: No map options given, please provide leaflet map options in the config file under mapProperties.options');\r\n    } else if (!this.mapProperties.options.center || !this.mapProperties.options.zoom) {\r\n      console.warn('Warning: Intial center and zoom of map are not set. These options can be input in the config file under mapProperties.options')\r\n    }\r\n    this.map = L.map(this.shadowRoot.getElementById('map'), this.mapProperties.options);\r\n    if (this.mapProperties.bounds) this.map.fitBounds(this.mapProperties.bounds);\r\n\r\n    this.map.zoomControl.setPosition('topright');\r\n    if (this.mapProperties.attributionPrefix)\r\n        this.map.attributionControl.setPrefix(this.mapProperties.attributionPrefix);\r\n    let menuToggle = this.shadowRoot.querySelectorAll('.menu-toggle');\r\n    menuToggle.forEach(t => t.onclick = this._toggleLayersMenu.bind(this));\r\n    this._markersGroup.addTo(this.map);\r\n\r\n    this._initializeState(decodeURI(location.hash));\r\n    this._initializeBaseMaps(rjson.baseMaps);\r\n    this._initializeOverlays(rjson.wmsDefaultSource);\r\n  }\r\n\r\n  initializeSearch(url) {\r\n    if (!url) {\r\n      console.error('Error: No URL given for address search. Please input URL in config file under searchUrl');\r\n      return;\r\n    }\r\n\r\n    let searchInput = this.shadowRoot.getElementById('search');\r\n    searchInput.oninput = function(e) {\r\n      if (!e.target.value) {\r\n        this._markersGroup.clearLayers();\r\n        if (this.map) {\r\n          if (this.selectedOverlay.initialCenter && this.selectedOverlay.initialZoom) {\r\n            this.map.flyTo(this.selectedOverlay.initialCenter, this.selectedOverlay.initialZoom);\r\n            if (this.selectedOverlay.fitBounds) {\r\n              if (window.innerWidth <= 600) {\r\n                this.map.flyToBounds(this.mapProperties.bounds);\r\n              } else {\r\n                this.map.flyToBounds(this.mapProperties.bounds, {\r\n                  paddingTopLeft: [250, 0],\r\n                  paddingBottomRight: [-50, 0]\r\n                });\r\n              }\r\n            }\r\n          } else {\r\n            this.map.flyTo(this.mapProperties.mapOptions.center, this.mapProperties.zoom);\r\n            if (this.mapProperties.bounds) this.map.fitBounds(this.mapProperties.bounds);\r\n          }\r\n        }\r\n      }\r\n    }.bind(this);\r\n\r\n    jQuery('#search', this.shadowRoot).autocomplete({\r\n      preventBadQueries: false,\r\n      deferRequestBy: 200,\r\n      minChars: 3,\r\n      serviceUrl: url,\r\n      paramName: 'q',\r\n      // params: { limit: 10 },\r\n      transformResult: function (response) {\r\n        let addresses = JSON.parse(response).addresses;\r\n        return {\r\n        suggestions: addresses.map(d => ({ value: d.address, data: d }))\r\n        }\r\n      },\r\n      onSearchStart: () => this.searchMakers = [],\r\n      onSearchComplete: function (q, s) {\r\n        this.searchMarkers = s.map(obj => (\r\n          { coords: [obj.data.latitude, obj.data.longitude], address: obj.data.address }\r\n        ));\r\n        this._markMap(this.searchMarkers);\r\n      }.bind(this),\r\n      onSelect: function (obj) { \r\n        this.searchMarkers = [{ coords: [obj.data.latitude, obj.data.longitude], address: obj.data.address }];\r\n        this._markMap(this.searchMarkers);\r\n      }.bind(this)\r\n    });\r\n  }\r\n\r\n  _initializeState(hash) {\r\n    if (hash !== '') {\r\n      let initialState = hash.substring(2)\r\n        .split('/');\r\n      if (initialState[0]) this.state.baseMap = initialState[0];\r\n      if (initialState[1] && this.overlayMaps) this.state.overlay = this.overlayMaps.findIndex(m => m.machineName === initialState[1]);\r\n      if (this.state.overlay === -1 && !isNaN(parseInt(initialState[1]))) this.state.overlay = parseInt(initialState[1]);\r\n      if (initialState[2]) this.state.layers = initialState[2].split(',');\r\n    }\r\n  }\r\n\r\n  _initializeBaseMaps(baseMaps) {\r\n    if (!baseMaps || !baseMaps.length) {\r\n      alert('No basemaps provided.');\r\n      console.error('Error: Please list basemap configuration properties in the config file as baseMaps[]');\r\n      return;\r\n    }\r\n\r\n    for (let i = 0; i < baseMaps.length; i++) {\r\n      let baseMapConfig = baseMaps[i];\r\n      if (!baseMapConfig.machineName) {\r\n        if (!baseMapConfig.name) baseMapConfig.name = 'Basemap ' + i\r\n        baseMapConfig.machineName = i\r\n      }\r\n      this.baseMapNames[baseMapConfig.machineName] = baseMapConfig.name;\r\n      \r\n      if (!baseMapConfig.source) {\r\n        console.error(`Error: No basemap source provided for ${baseMapConfig.name}, please provide source URL in the config file under baseMaps[].source`);\r\n        continue;\r\n      }\r\n      if (!baseMapConfig.options) {\r\n        console.warn(`Warning: No basemap options given for ${baseMapConfig.name}, please provide leaflet basemap options in the config file under baseMaps[].options`);\r\n      } else if (!baseMapConfig.options.maxZoom && this.mapProperties.options) {\r\n        baseMapConfig.options.maxZoom = this.mapProperties.options.maxZoom;\r\n      }\r\n\r\n      switch (baseMapConfig.format) {\r\n        case 'XYZ':\r\n          this.baseMaps[baseMapConfig.name] = L.tileLayer(baseMapConfig.source, baseMapConfig.options);\r\n          break;\r\n        case 'WMS':\r\n          if (!baseMapConfig.options.format) baseMapConfig.options.format = 'image/png';\r\n          this.baseMaps[baseMapConfig.name] = L.tileLayer.wms(baseMapConfig.source, baseMapConfig.options);\r\n          break;\r\n        default:\r\n          console.error(`Error: Invalid Tile Layer Format for ${baseMapConfig.name}: ${baseMapConfig.format}. Please check baseMaps[].format in config file`);\r\n          continue;\r\n      }\r\n\r\n      this.baseMaps[baseMapConfig.name].on('tileerror', function() {\r\n        console.error(`Error: Unable to load basemap layer ${baseMapConfig.name}, check source and options for baseMaps[] in config file`);\r\n      });\r\n      if (!this.state.baseMap && baseMapConfig.default) {\r\n        this.state.baseMap = baseMapConfig.machineName;\r\n      }\r\n    }\r\n\r\n    if (Object.keys(this.baseMaps).length) {\r\n      if (!this.state.baseMap || !this.baseMaps[this.baseMapNames[this.state.baseMap]]) {\r\n        this.state.baseMap = Object.keys(this.baseMapNames).find(key => this.baseMapNames[key] === Object.keys(this.baseMaps)[0]);\r\n        console.warn(`Warning: The basemap requested in the URL does not exist. Defaulting to ${this.baseMapNames[this.state.baseMap]}.`);\r\n        this._pushState();\r\n      }\r\n      this.baseMaps[this.baseMapNames[this.state.baseMap]].addTo(this.map);\r\n      L.control.layers(this.baseMaps).addTo(this.map).setPosition('bottomright');\r\n      this.map.on('baselayerchange', function(e) {\r\n        let newBaseMap = Object.keys(this.baseMapNames).find(key => this.baseMapNames[key] === e.name);\r\n        if (this.state.baseMap !== newBaseMap) {\r\n          this.state.baseMap = newBaseMap\r\n          this._pushState();\r\n        }\r\n      }.bind(this));\r\n    }\r\n  }\r\n\r\n  _initializeOverlays(wmsDefaultSource) {\r\n    if (!this.overlayMaps || !this.overlayMaps.length) {\r\n      alert('No overlay layers provided.');\r\n      console.error('Error: Please list overlay configuration properties in the config file as overlayMaps[]');\r\n      return;\r\n    }\r\n\r\n    if (!wmsDefaultSource) {\r\n      console.warn('Warning: wmsDefaultSource not set in config file. Layers may not display');\r\n    }\r\n\r\n    let accordionDiv = document.createElement('div');\r\n    accordionDiv.classList.add('accordion', 'accordion-flush');\r\n    this.shadowRoot.getElementById('overlays').appendChild(accordionDiv);\r\n\r\n    // iterate through overlay groups\r\n    for (let i = 0; i < this.overlayMaps.length; i++) {\r\n      let overlayConfig = this.overlayMaps[i];\r\n      if (!this.state.overlay && overlayConfig.default) this.state.overlay = i;\r\n      if (!overlayConfig.machineName) this.overlayMaps[i].machineName = i;\r\n      if (!overlayConfig.name) this.overlayMaps[i].name = 'Overlay ' + i;\r\n      if (!overlayConfig.layers || !Object.keys(overlayConfig.layers).length) {\r\n        console.error(`Error: Overlay ${this.overlayMaps[i].name} does not have any layers. Please set them in the config file under overlayMaps[].layers`);\r\n        return;\r\n      }\r\n\r\n      let overlayTemplate = document.createElement('template');\r\n      overlayTemplate.innerHTML =  /*html*/`\r\n        <div class='accordion-item'>\r\n          <h2 class='accordion-header' id=${overlayConfig.machineName}>\r\n            <button class='overlay-item accordion-button collapsed' id=${i} type='button' value=${overlayConfig.machineName}>\r\n              ${overlayConfig.name}\r\n            </button>\r\n          </h2>\r\n          <div class='accordion-collapse collapse' id=${overlayConfig.machineName + '-layers'}>\r\n            <ul class='overlay-layers list-group list-group-flush'>\r\n            </ul>\r\n          </div>\r\n        </div>\r\n      `;\r\n\r\n      let overlayItem = overlayTemplate.content.firstElementChild.cloneNode(true);\r\n      overlayItem.querySelector('h2').title = overlayConfig.description ? overlayConfig.description : this.overlayMaps[i].name;\r\n      overlayItem.querySelector('button').onclick = this._toggleOverlay.bind(this);\r\n      accordionDiv.appendChild(overlayItem);\r\n\r\n      let overlayCollapse = this.shadowRoot.getElementById(overlayConfig.machineName + '-layers');\r\n      this.overlayCollapses[overlayConfig.machineName] = new bootstrap.Collapse(overlayCollapse, {\r\n        toggle: false\r\n      });\r\n\r\n      let startCollapse = function(e) {\r\n        let item = this.shadowRoot.getElementById(e.target.id.slice(0, -7));\r\n        item.querySelector('button').disabled = true;\r\n      }.bind(this);\r\n\r\n      let postCollapse = function(e) {\r\n        let item = this.shadowRoot.getElementById(e.target.id.slice(0, -7));\r\n        item.querySelector('button').disabled = false;\r\n      }.bind(this);\r\n\r\n      overlayCollapse.addEventListener('show.bs.collapse', startCollapse);\r\n      overlayCollapse.addEventListener('hide.bs.collapse', startCollapse);\r\n      overlayCollapse.addEventListener('shown.bs.collapse', postCollapse);\r\n      overlayCollapse.addEventListener('hidden.bs.collapse', postCollapse);      \r\n\r\n      let layerList = overlayItem.querySelector('ul');\r\n      let layers = this.overlayMaps[i].layers;\r\n      this.overlayMaps[i].flattenedLayers = [];\r\n\r\n      // iterate through layer interaction types (always on, exclusives, optionals)\r\n      for (let type in layers) {\r\n\r\n        // iterate through all layers\r\n        for (let j = 0; j < layers[type].length; j++) {\r\n          layers[type][j].interaction = type;\r\n          let layer = layers[type][j];\r\n          if (!layer.machineName) layers[type][j].machineName = type + i + j;\r\n          if (!layer.name) layers[type][j].name = `${type} layer ${i}.${j}`;\r\n          if (type === 'alwaysOn') {\r\n            layers[type][j].visible = true;\r\n          } else {\r\n            let layerTemplate = document.createElement('template');\r\n            layerTemplate.innerHTML = /*html*/`\r\n              <li class='list-group-item d-flex justify-content-start' id=${layer.machineName}>\r\n                <label class='switch'>\r\n                  <input type='checkbox' class='overlay-layers-toggle' disabled>\r\n                  <span class='slider'></span>\r\n                </label>\r\n                <span class='mr-auto'>${layer.name}</span>\r\n                <a href='#' class='ms-auto'>\r\n                  <i class='fa fa-fw fa-download' title=${'Download ' + layer.name}></i>\r\n                </a>\r\n              </li>\r\n            `;\r\n\r\n            let layerItem = layerTemplate.content.firstElementChild.cloneNode(true);\r\n            layerItem.onclick = function () {\r\n              this._toggleLayer(layer.machineName);\r\n            }.bind(this);\r\n\r\n            layerItem.querySelector('a').onclick = function (e) {\r\n              e.stopPropagation();\r\n              e.preventDefault();\r\n              this._downloadLayer(layer);\r\n            }.bind(this);\r\n\r\n            layerList.appendChild(layerItem);\r\n          }\r\n\r\n          if (\r\n            (layers[type][j].type === 'wms' || layers[type][j].type === undefined)\r\n            && layers[type][j].source === undefined\r\n          ) {\r\n\r\n            layers[type][j].type = 'wms';\r\n            layers[type][j].source = wmsDefaultSource;\r\n          }\r\n        }\r\n\r\n        this.overlayMaps[i].flattenedLayers = this.overlayMaps[i].flattenedLayers.concat(layers[type]);\r\n      }\r\n    }\r\n\r\n    if (!location.hash) {\r\n      this.overlayMaps[this.state.overlay].flattenedLayers.filter(l => l.visible && l.interaction !== 'alwaysOn')\r\n        .forEach(l => {\r\n          this.state.layers.push(l.machineName.split('.')[1])\r\n        });\r\n    }\r\n\r\n    if (!this.overlayMaps[this.state.overlay]) {\r\n      this.state.overlay = 0\r\n      console.warn(`Warning: The overlay requested by the URL does not exist. Defaulting to ${this.overlayMaps[0].name}.`);\r\n      this._pushState();\r\n    }\r\n    this.toggleCollapse(this.overlayMaps[this.state.overlay].machineName);\r\n    this.overlaySelect(this.state.overlay);\r\n  }\r\n\r\n  _toggleOverlay(e) {\r\n    let button = e.target;\r\n    let id = button.getAttribute('value');\r\n    if (!this.flat) this.toggleCollapse(id);\r\n    if (!button.classList.contains('collapsed')) {\r\n      let index = button.getAttribute('id')\r\n      if (this.state.overlay !== index || !location.hash){\r\n        this.state.overlay = index;\r\n        this.state.layers = [];\r\n        this.overlayMaps[index].flattenedLayers.filter(l => l.visible && l.interaction !== 'alwaysOn')\r\n          .forEach(l => {\r\n            this.state.layers.push(l.machineName.split('.')[1])\r\n          });\r\n      }\r\n      this.overlaySelect(this.state.overlay);\r\n      this._pushState();\r\n    } else {\r\n      this.selectedOverlay.collapsed = true;\r\n    }\r\n  }\r\n\r\n  _toggleLayer(layerName) {\r\n    let layerIndex = this.selectedOverlay.flattenedLayers.findIndex(l => l.machineName === layerName && l.interaction !== 'alwaysOn');\r\n    let layer = this.selectedOverlay.flattenedLayers[layerIndex];\r\n    let shortName = layerName.split('.')[1];\r\n\r\n    // First save the current state\r\n    let currVisible = layer.visible;\r\n\r\n    if (layer.interaction === 'exclusives' && !currVisible) {\r\n      // Turn all exclusive layers off\r\n      for (let i = 0; i < this.selectedOverlay.flattenedLayers.length; i++) {\r\n        if (this.selectedOverlay.flattenedLayers[i].interaction === 'exclusives') {\r\n          this.selectedOverlay.flattenedLayers[i].visible = false;\r\n        }\r\n      }\r\n\r\n      this.state.layers = [];\r\n    }\r\n\r\n    if (currVisible) {\r\n      let i = this.state.layers.indexOf(shortName);\r\n      if (i > -1) {\r\n        this.state.layers.splice(i, 1);\r\n      }\r\n    } else {\r\n      this.state.layers.push(shortName);\r\n    }\r\n\r\n    // Compute toggle on original state\r\n    this.selectedOverlay.flattenedLayers[layerIndex].visible = !currVisible;\r\n\r\n    this._parseLayers();\r\n    this._pushState();\r\n  }\r\n\r\n  toggleCollapse(id) {\r\n    let item = this.shadowRoot.getElementById(id);\r\n    let button = item.getElementsByTagName('button')[0];\r\n    button.classList.toggle('collapsed');\r\n    button.classList.toggle('selected');\r\n    this.overlayCollapses[id].toggle();\r\n  }\r\n\r\n  overlaySelect(index) {\r\n    if (this.selectedOverlay !== this.overlayMaps[index]) {\r\n      if (this.selectedOverlay && !this.selectedOverlay.collapsed) {\r\n        this.toggleCollapse(this.selectedOverlay.machineName);\r\n      }\r\n      \r\n      this.selectedOverlay = this.overlayMaps[index];\r\n    }\r\n\r\n    this.selectedOverlay.collapsed = false;\r\n    this._parseLayers();\r\n    \r\n    if (this.selectedOverlay.resetViewOnSelect) {\r\n      this.map.flyTo(this.selectedOverlay.initialCenter, this.selectedOverlay.initialZoom);\r\n    }\r\n    if (this.selectedOverlay.fitBounds) {\r\n      if (window.innerWidth <= 600) {\r\n        this.map.flyToBounds(this.mapProperties.bounds);\r\n      } else {\r\n        this.map.flyToBounds(this.mapProperties.bounds, {\r\n          paddingTopLeft: [250, 0],\r\n          paddingBottomRight: [-50, 0]\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  async _parseLayers() {\r\n    let layers = this.selectedOverlay.flattenedLayers;\r\n    let wmsLayers = {};\r\n\r\n    this._syncStateLayers();\r\n\r\n    layers\r\n      .filter(l => l.visible)\r\n      .forEach(async(l) => {\r\n        if (l.type === 'wms') {\r\n          // group the sources\r\n          wmsLayers[l.source] = wmsLayers[l.source] || { layers: [] };\r\n          wmsLayers[l.source].layers.push(l.machineName);\r\n        } else if (l.type === 'geojson' && !this.geojsonLayers[l.machineName]) {\r\n          let response = await fetch(l.source);\r\n          if (!response.ok) {\r\n              console.error(`Error: The source for GeoJSON layer ${l.name} could not be fetched. Status: ${response.status}`);\r\n          }\r\n          let data = await response.json();\r\n          this._createGeoJSONLayer(l, data);\r\n        }\r\n      });\r\n\r\n    layers.forEach(l =>  {\r\n      let layerItem = this.shadowRoot.getElementById(l.machineName);\r\n      if (layerItem) {\r\n        let slider = layerItem.getElementsByTagName('input')[0];\r\n        if (l.visible && l.interaction !== 'alwaysOn') {\r\n          slider.checked = true;\r\n          if (this.geojsonLayers[l.machineName]) this.geojsonLayers[l.machineName].addTo(this.map);\r\n        } else {\r\n          slider.checked = false;\r\n          if (this.geojsonLayers[l.machineName]) this.geojsonLayers[l.machineName].removeFrom(this.map);\r\n        }\r\n      }\r\n    });\r\n\r\n    // flattened the grouped WMS sources\r\n    for (let s in wmsLayers) {\r\n      if (!this.wmsGroups[s]) {\r\n        this.wmsGroups[s] = WMS.source(s, {\r\n          format: 'image/png',\r\n          transparent: true,\r\n          identify: false\r\n        });\r\n        this.wmsGroups[s].addTo(this.map);\r\n      }\r\n      this.wmsGroups[s].replaceAllSubLayers(wmsLayers[s].layers);\r\n    }\r\n\r\n    for (let s in this.wmsGroups) {\r\n      if (!(s in wmsLayers)) {\r\n        this.wmsGroups[s].removeFrom(this.map);\r\n      }\r\n    }\r\n  }\r\n\r\n  _pushState() {\r\n    let stateOverlay = this.overlayMaps ? this.overlayMaps[this.state.overlay].machineName : '';\r\n    let stateLayers = this.state.layers.join();\r\n    let hash = '#'.concat('/', this.state.baseMap, '/', stateOverlay);\r\n    if (stateLayers) hash = hash.concat('/', stateLayers);\r\n    if (history.pushState) {\r\n      history.pushState(this.state, '', hash);\r\n    }\r\n    else {\r\n        location.hash = hash;\r\n    }\r\n  }\r\n\r\n  _syncStateLayers() {\r\n    let visibleLayers = [];\r\n    for (let i = 0; i < this.selectedOverlay.flattenedLayers.length; i++) {\r\n      let layer = this.selectedOverlay.flattenedLayers[i];\r\n      let shortName = layer.machineName.split('.')[1];\r\n      if (layer.interaction !== 'alwaysOn') {\r\n        if (this.state.layers.includes(shortName)) {\r\n          if (layer.interaction === 'exclusives' && this.state.layers.length > 1) {\r\n            let j = this.state.layers.findIndex(l => l === shortName);\r\n            if (j === 0) {\r\n              this.state.layers = [shortName];\r\n              this.selectedOverlay.flattenedLayers[i].visible = true;\r\n              console.warn(`Warning: The layer ${shortName} is exclusive. All other layers have been removed.`);\r\n              this._pushState();\r\n              return;\r\n            } else {\r\n              this.state.layers.splice(j, 1);\r\n              console.warn(`Warning: The layer ${shortName} is exclusive and has been removed.`);\r\n              this._pushState();\r\n            }\r\n          } else {\r\n            this.selectedOverlay.flattenedLayers[i].visible = true;\r\n            visibleLayers.push(shortName);\r\n          }\r\n        } else { \r\n          this.selectedOverlay.flattenedLayers[i].visible = false;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (visibleLayers.length < this.state.layers.length) {\r\n      let notLayers = this.state.layers.filter(l => !visibleLayers.includes(l))\r\n      this.state.layers = visibleLayers\r\n      console.warn(`Warning: The following layer(s) do not exist in current overlay: ${notLayers.join(', ')}.`)\r\n      this._pushState();\r\n    }\r\n  }\r\n\r\n  _createGeoJSONLayer(layer, data) {\r\n    let clusterGroup;\r\n    if (layer.cluster) {\r\n      clusterGroup = L.markerClusterGroup({\r\n        showCoverageOnHover: false,\r\n        maxClusterRadius: layer.maxClusterRadius ? layer.maxClusterRadius : 80\r\n      });\r\n    }\r\n\r\n    let geoJSONOptions = {\r\n      pointToLayer: function (feature, latlng) {\r\n        let marker = L.circleMarker(latlng, layer.markerStyle);\r\n        if (layer.identify) marker.bindPopup(this._generatePopupContent(feature));\r\n        if (layer.cluster) clusterGroup.addLayer(marker);\r\n        return marker;\r\n      }.bind(this),\r\n      attribution: layer.attribution\r\n    };\r\n\r\n    let geoJSONLayer = L.geoJSON(data, geoJSONOptions);\r\n    if (layer.cluster) {\r\n      this.geojsonLayers[layer.machineName] = clusterGroup;\r\n    } else {\r\n      this.geojsonLayers[layer.machineName] = geoJSONLayer;\r\n    }\r\n\r\n    this.geojsonLayers[layer.machineName].addTo(this.map)\r\n  }\r\n\r\n  _generatePopupContent(feature) {\r\n    let rows = '';\r\n    for (let p in feature.properties) {\r\n      let fieldName = p.replace(/\\w\\S*/g, function(txt){ return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase().replace('_', ' '); })\r\n      rows += `<tr><td>${fieldName}:</td><td><strong>${feature.properties[p]}</strong></td></tr>`;\r\n    }\r\n\r\n    return `<table>${rows}</table>`;\r\n  }\r\n\r\n  _markMap(markersData) {\r\n    this._markersGroup.clearLayers();\r\n    if (markersData.length === 0) return;\r\n\r\n    markersData.forEach(m => {\r\n      this._markersGroup\r\n        .addLayer(L.marker(m.coords, {\r\n          icon: L.icon({\r\n            iconUrl: icon,\r\n            shadowUrl: iconShadow,\r\n            iconSize: [25, 41],\r\n            iconAnchor: [12, 41],\r\n            popupAnchor: [1, -34],\r\n            tooltipAnchor: [16, -28],\r\n            shadowSize: [41, 41]\r\n          })\r\n        }).bindPopup(m.address))\r\n    });\r\n\r\n    if (markersData.length === 1) this.map.flyTo(markersData[0].coords);\r\n    else this.map.fitBounds(this._markersGroup.getBounds());\r\n  }\r\n\r\n  _toggleLayersMenu() {\r\n    let layersMenu = this.shadowRoot.querySelector('main#layers-menu');\r\n    layersMenu.classList.toggle('show');\r\n  }\r\n\r\n  _downloadLayer(layer) {\r\n    let dom = this.shadowRoot;\r\n    dom.appendChild(downloadTemplate.content.cloneNode(true));\r\n    \r\n    let modal = new bootstrap.Modal(dom.getElementById('download-modal'));\r\n    dom.getElementById('modal-close').onclick = () => modal.hide();\r\n\r\n    let downloadURL = this.downloadProperties.source + layer.machineName;\r\n\r\n    dom.getElementById('layer-name').textContent = layer.name;\r\n    let downloadLinks = dom.querySelector('.modal-footer');\r\n    if (!this.downloadProperties.options || !this.downloadProperties.options.length) {\r\n      console.error('Error: No download options given. Please specify in the config file under downloadProperties.options')\r\n      return;\r\n    }\r\n    this.downloadProperties.options.forEach( opt => {\r\n      let link = document.createElement('template');\r\n      link.innerHTML = /*html*/`\r\n        <a href=${downloadURL + opt.formatUrl} target='_blank' class='btn btn-secondary'>\r\n          <i class='fa fa-download'></i> ${opt.type}\r\n        </a>\r\n      `;\r\n      downloadLinks.appendChild(link.content.cloneNode(true));\r\n    });\r\n\r\n    modal.show();\r\n  }\r\n}\r\n\r\ncustomElements.define('gg-map-portal', GGMapPortal);\r\n"]}